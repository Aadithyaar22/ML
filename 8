# Program 8 - Non-Parametric Locally Weighted Regression (notebook exact)
import matplotlib.pyplot as plt
import pandas as pd
import numpy as np

def kernel(point, xmat, k):
    """
    notebook kernel(point, xmat, k)
    returns diagonal weight matrix (m x m) for point
    """
    m = np.shape(xmat)[0]
    weights = np.mat(np.eye(m))
    for j in range(m):
        diff = point - xmat[j]
        # squared distance (1D or multi-dim)
        sqdist = float(np.dot(diff, diff))
        weights[j, j] = np.exp(-sqdist / (2 * k * k))
    return weights

def localWeight(point, xmat, ymat, k):
    """
    notebook localWeight(point, xmat, ymat, k)
    computes prediction for a single point using weighted linear regression
    """
    w = kernel(point, xmat, k)
    X = np.mat(xmat)          # m x n
    Y = np.mat(ymat).T       # m x 1
    # theta = (X^T W X)^{-1} X^T W Y
    XT_W = X.T * w
    try:
        theta = (XT_W * X).I * (XT_W * Y)
    except Exception:
        # in case of singular matrix, use pseudo-inverse
        theta = np.linalg.pinv(np.array(XT_W * X)) @ np.array(XT_W * Y)
        theta = np.mat(theta)
    # point should be 1 x n
    pred = np.mat(point) * theta
    return float(pred)

def localWeightRegression(xmat, ymat, k):
    """
    notebook localWeightRegression(xmat, ymat, k)
    returns predictions for each row in xmat
    """
    m = np.shape(xmat)[0]
    ypred = np.zeros(m)
    for i in range(m):
        ypred[i] = localWeight(xmat[i], xmat, ymat, k)
    return ypred

def graphPlot(x, ypred):
    """
    notebook graphPlot(x, ypred)
    scatter original points and plot predicted curve
    """
    # sort by the feature (assumes feature at column index 1 is bill)
    sortIndex = x[:, 1].argsort(0)
    xsort = x[sortIndex][:, 0]
    fig = plt.figure()
    ax = fig.add_subplot(1, 1, 1)
    # scatter original points (total bill vs tip)
    ax.scatter(x[:, 1], x[:, 0], c='green')
    # plot predicted curve (sorted)
    ax.plot(xsort[:, 0], ypred[sortIndex.flatten()], color='red', linewidth=5)
    plt.xlabel('Total Bill')
    plt.ylabel('Tip')
    plt.show()

# --------------------------
# Use dataset as in notebook
# --------------------------
data = pd.read_csv('tips.csv')

# matching the notebook variable names
mbill = np.array(data.total_bill)
mtip  = np.array(data.tip)

m = np.shape(mbill)[0]
one = np.ones((m, 1))

# X matrix as notebook: column of ones and bill values
X = np.column_stack((one, mbill))

# predict using local weight regression (k as in notebook example: 8)
ypred = localWeightRegression(X, mtip, 8)

# plot results as in notebook
graphPlot(X, ypred)
